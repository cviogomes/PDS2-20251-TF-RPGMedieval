#include <iostream>
#include <vector>
#include <memory>
#include <string>
#include <ctime>
#include <cstdlib>
#include <limits>

#include "Utils.hpp"
#include "Jogador.hpp"
#include "Combate.hpp"

#include "Zumbi.hpp"
#include "Esqueleto.hpp"
#include "Vampiro.hpp"
#include "Goblin.hpp"
#include "Slime.hpp"
#include "Aranha.hpp"
#include "Lobisomem.hpp"
#include "Bruxa.hpp"

#include "CavaleiroDaPeste.hpp"
#include "CavaleiroDaFome.hpp"
#include "CavaleiroDaGuerra.hpp"
#include "CavaleiroDaMorte.hpp"

void lutar(Jogador& jogador, std::vector<std::unique_ptr<Inimigo>>& inimigos) {
    for (auto& inimigo : inimigos) {
        if (!jogador.estaVivo()) break;

        battlePrint("\n" + inimigo->getNome() + " apareceu!\n");
        if (inimigo->getNome() == "Zumbi"){
            std::cout << R"(
                                                          ######--                                              
                                      ########--::--@@++::--##                                      
                                  ..++------MM++::::##++::::::++####--                              
                              @@@@##mm::++::mm++--++::MMmm++##::--  --##                            
                          ##..--::++##mmmm++++mm@@MMmm----::++++::------::                          
                        ##::--++mm::--mm::::++::::##++::::mmmm::MM::::::##                          
                      ++mm::::++::::::##::mm++@@####mmmmmmmm::::..@@mmmm##MM##mm                    
                      MMmm++::++mm::::##::::##::::::##--::mm++++::##mmmmMM::----                    
                      ::mmmmmm::mm++mm##@@##mmmm++##----++++mmmmmmmm++@@mm::::::MM                  
                  --MM--::++++MM@@######mmmmmmmm##mm::::::::mm####::::mmmmmmmmmm                    
                  ++--::@@::::::mmmmMM@@MMmmmm####@@mmMMMM@@::@@mmMM++++++@@mm++##                  
                ##::::##::::::::##@@####@@##++..    ++@@mm::++MM++mm@@::::::++::--##                
                ##++++##mmmm@@mm##@@  @@mm::::::------  MM####mmmm##mm##MMmm++##::##MM              
              ####mmmm####++  ####  ----MMMM::------MM----::--::..  MMMM++::::MMmm####              
              ##MM######  ..::@@----::::::--::------::::::------mmMM--::####mm@@mmmm##::##          
              ##..@@@@  ::--::::MM--::::::::::------------::::----::----..  ##@@@@####..++          
              ##++++..------++++----::------------------------------------::..    ..mmmm            
            --@@mm::::++--::--::--::::--::::::::----------++::--------::--::----::--mmmm            
            MM##++--::##::----------------::MMmmmm++@@++--::----::------------MM----++mm::          
            @@##::::MM##--::::--------++++------..----::--++##mm----::----::----::--##mm##          
            @@##::--::MMMM::--......----::--MM@@@@@@@@MM::----::--::::::::::--++--@@MM++--          
            mm@@::--mm++--..--::--..    ..::----::--::::----::--            ::##--::++mm            
              MM::::MM::--::::::--------    ::----::::--::--    ..------::::::++@@::mm##            
              ##mm##mmmmMMmmmm@@::mm------  --##----mmmm--  ------::++@@mmmmmmmmMM++mm##            
              mmmm##mm##########MM@@mm++--::--------++------::++mmmmmmmm####MMmmmm@@MM              
                ##MM##mm..        ######mmmm++mm##@@##----::mmMM@@####MM--::##mmMMmm##              
                ++mmmmMM              ####mmmmmm####@@mmmm++mm##++          --mmMMmm                
        @@######  @@##mm                ::##mmmm##mm##mmmm##::              ..::MM##  ..##::        
      ##..::----mm##MM::--              --::@@MMMM++##mm##--                mm::##mm##  --  ##      
      MM++MM@@mm::@@::::@@              ..######@@--::####                  @@--MM##----mm++--##    
      --##mm####@@##::::mm##            ##@@mm##  ::..----##              ##++--mm##mm######mm##    
    ..##mm##########--  --@@++########++##::mm--##::##::--++mm##      @@##++::--MM########mmMM@@    
      mmMM##@@@@--##MM--  ::--mmmm::##::::--++####++####::--::##++MMMM####::--##MM@@::##@@MMmm##    
      ##mm@@@@##--mm##@@::::----::--------::--####MM####----::--::mm--::--::@@####::::####mmmm##    
      ##mm######mmmm####mm----------------::::####--####::--------::--::::--MM####mm::##@@##mm##    
        ##mm##@@####MM##MM::++::--------::::::##@@##--##MM----------++##::mm@@##@@####MM##mm##      
        MMmm++::MM##mm####mm##++mm------------++::++::--::::--::mmmmmmMMMMmm##@@@@mmmm++mmMMmm      
          @@mm++mmmm##@@##MMmm@@..mm::----------------------++##MMmm@@++mmMM##@@mmMM::++mm##        
            --####@@@@####MM::..  ##mmMM--..mm..::::--::@@mmmm##  ##@@::--######@@mm++####          
                  ..      @@::..  ##MM  @@::mm++::@@::MM####  ##  ##MM::@@##..@@####@@              
                          ##--::##  @@  ##mm  @@..  ########  ##  ##@@----@@                        
                          ##----MM  ++  ..    ##    --######  ::  ##@@::::##                        
                          ##++--mm##MM  ##    ..      ####++  MM####@@::MM##                        
                          @@MM--++####  ..######      ################::--##                        
                          ::----++####################################::++##                        
                        ##::::--++####################################::##@@                        
                      ::mm++----############################    ######--MM::..                      
                        ##mm@@--######  mm##################mm  MMMM##--++::##                      
                          ##++--####MM  mm  MM################++MMmm##--@@@@@@                      
                            ##::--MMmmMM    ##  ####MM########@@@@MM##--::mm##                      
                              ##--++@@mmmm  mm  ##    ::######MM@@##--@@++##                        
                                ##--++@@####MM--##--  ######MM##MM--++++@@                          
                                --mm::::##MMmmmmmmMM++mmMM##::  ----mm++                            
                                  ##::--  --@@@@########mm  --::--++@@                              
                                  --mm::--::--..--....----------++##                                
                                    ##mm++::----------::----::++mm--                                
                                    --mm++mmmm++##mm::++++++mmmm##                                  
                                      ##mmmm++##@@  ##mmmmmmMM##                                    
            )" << "\n";
        } 
        else if (inimigo->getNome() == "Esqueleto"){
            std::cout << R"(
                                         _.--""-._                     
  .                         ."         ".                   
 / \    ,^.         /(     Y             |      )\|           
/   `---. |--'\    (  \__..'--   -   -- -'""-.-'  )         
|        :|    `;   '.     l_..-------.._l      .'          
|      __l;__ .'      "-.__.||_.-'v'-._||`"----"            
 \  .-' | |  `              l._       _.'                   
  \/    | |                   l`^^'^^'j                     
        | |                _   \_____/     _                
        j |               l `--__)-'(__.--' |               
        | |               | /`---``-----'"1 |  ,-----.      
        | |               )/  `--' '---'   \'-'  ___  `-.   
        | |              //  `-'  '`----'  /  ,-'   I`.  \|  
      _ L |_            //  `-.-.'`-----' /  /  |   |  `. \|  
     '._' / \         _/(   `/   )- ---' ;  /__.J   L.__.\ :
      `._;/7(-.......'  /        ) (     |  |            | |
      `._;l _'--------_/        )-'/     :  |___.    _._./ ;
        | |                 .__ )-'\  __  \  \  I   1   / / 
        `-'                /   `-\-(-'   \ \  `.|   | ,' /  
                           \__  `-'    __/  `-. `---'',-'   
                              )-._.-- (        `-----'      
                             )(  l\ o ('..-.                
                       _..--' _'-' '--'.-. |                
                __,,-'' _,,-''            \ \\|                
               f'. _,,-'                   \ \\|               
              ()--  |                       \ \\|              
                \.  |                       /  \\|             
                  \ \                      |._  |           
                   \ \                     |  ()|           
                    \ \                     \  /            
                     ) `-.                   | |            
                    // .__)                  | |            
                 _.//7'                      | |            
               '---'                         j_| `          
                                            (| |            
                                             |  \|           
                                             |lllj          
                                             ||||| 
            )" << "\n";
        }
        else if (inimigo->getNome() == "Vampiro"){
            std::cout << R"(
                                       ..######################                                      
                                  ..##mm                      ####                                  
                                MM##                              ##::                              
                              ..##                                  ##                              
                              ##        mm                            ##                            
                              ##    ##mm..mm##        mm##mmmm##::    ##                            
                            ..++  ##          ##    --##        ##..  mm                            
                            ##  @@++          ..##  ##            ##  mm                            
                        ::  ##  ##              MM##              MM::mm  MM                        
                        ######--++                                  ##mm##mm..                      
                        ##  ####                                    ####  ::--                      
                        ##    ##                                    ##    ++..                      
                        ##    ##    @@####--              ######    ##    @@                        
                        ##    ##    mm    @@####    --####      ##  ##    ##                        
                        ##    ##    ##        ##    ##..      ##--  ##    ##                        
                        ..##  ##      ########..      ########..    ##    @@                        
              ####MMMMMMMM##++##                                    ##..##############@@            
                ##          --##                                    ####            ##              
                  ##          @@                                    ##            ##                
                    ##        --mm                                  ##          ##                  
                    --##        ##        ##################      @@--        ##                    
                      mm@@      MM++       ##            ##        ##        @@++                    
                        ##--      ##                            ##        --##                      
                          ##        ##                        ##::        ##                        
                            ##        ##MM                  ####        ##                          
                              ##      MM######--    ..MM##@@##        ##                            
                              ##        ##    --MM@@::..  ##          ##                            
                              mm          ##            mmmm          MM                            
                            ##            ##            ##            ..@@                          
                            ##              ##        ##                ##                          
                            ##              ##      MM::                ##                          
                            ##                ##    ##                  ##                          
                          MM                  ##  ##                    ::++                        
                          ##                  mm##--                      ##                        
                          ##                    ##                        ##                        
                          ##                    ##                        ##                        
                        --::                    ##                        mm..                      
                        ##                      ++--                      ..mm                      
                        ##                        ##                        ##                      
                        ######################################################                      

            )" << "\n";
        }
        else if (inimigo->getNome() == "Aranha"){
            std::cout << R"(
            $               $           
          $$                 $$         
         $$                   $$        
        $$                     $$       
        $$                     $$       
        $$                     $$       
         $$                   $$        
     $$  $$                   $$  $$    
    $$   $$                   $$   $$   
   $$     $$                 $$     $$  
   $       $$$             $$$       $  
   $$       $$$           $$$       $$  
   $$$       $$$  $$$$$  $$$       $$$  
    $$$$$$    $$$$$$$$$$$$$   $$$$$$$   
         $$$$$$$$$$$$$$$$$$$$$$         
    $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$    
   $$$ $$$$$$$$$$$$$$$$$$$$$$$$$$ $$$   
  $$$         $$$$$$$$$$$$         $$$  
 $$         $$$$$$$$$$$$$$$$$        $$ 
 $$     $$$$$$$$$$$$$$$$$$$$$$$$     $$ 
$$     $$$  $$$$$$$$$$$$$$$$  $$$     $$
 $$    $$   $$$$$$$  $$$$$$$   $$    $$ 
  $    $$   $$$$$$$  $$$$$$$   $$    $  
   $   $$   $$$$$$$$$$$$$$$$   $$   $   
    $  $$    $$$$$$$$$$$$$$    $$  $    
       $$     $$$$$$$$$$$$     $$       
       $$       $$$$$$$$       $$       
        $$                    $$        

            )" << "\n";
        }
        else if (inimigo->getNome() == "Lobisomem"){
            std::cout << R"(
            ####################################################################################################
####################################################################################################
##########################################@@..          ..##########################################
####################################::                          @@##################################
################################..                                  @@##############################
##############################                                          ############################
##########################mm                                              ##########################
########################::                            ++@@                  @@######################
######################mm                            ##::##                    ######################
####################@@                              ########                    ####################
####################                                ##########                    ##################
##################::                                ##########--                  MM################
##################                                  ############                    ################
################::                                  ##########::                    @@##############
################                                  @@############                      ##############
################                                ################@@                    ##############
##############++                              ..##################                    ##############
##############..                              ++##################                    mm############
##############                                MM##################                    --############
##############                                ####################--                  --############
##############              ++..##            ######################                  --############
##############          ..MM++--mmmm      mm##############    --####                  --############
##############              ++++########################        ######::              ::############
##############::                          --############          ######              ##############
##############@@                        ################          mm####..  mm        ##############
##############@@                    ..##################            ++######::        @@############
################                    ####################              MM####++::    ++##############
##############@@@@                ############  ########                ####@@--    ################
################@@              ##########--    ++######MM                MM      --@@##############
################@@@@          ##########        MM######@@                        ##################
################@@##--        MM########--      ############                    MM@@################
################@@@@@@            ++######..    ############--                --@@@@################
##################@@@@@@              ..####    ##..    MM####              ..@@@@@@################
##################@@@@@@@@            mm##::    @@        MM####          ..@@@@@@##################
################@@@@@@@@@@@@..        ####        ::        ####        ::##@@@@@@##################
########@@@@@@@@@@@@@@@@@@@@@@MM    ####..                  ####      @@@@@@@@@@@@@@@@##############
######@@@@@@@@@@@@@@@@@@@@@@@@@@######MM                    ####--MM@@@@@@@@@@@@@@@@@@@@############
@@@@@@@@@@@@@@@@@@@@@@@@@@@@############::                  ########@@@@@@@@@@@@@@@@@@@@@@@@@@######
@@@@@@@@@@@@@@@@@@@@@@@@@@######################################################@@####@@@@@@@@######
            )" << "\n";
        }
        else if (inimigo->getNome() == "Slime"){
            std::cout << R"(
                                                            ++####MM                                            
                                          ####################..                                    
                                      ############################                                  
                                    ######..  MM####################..                              
                                  ######      ########################..                            
                                ######      ############################                            
                              ########  ::################################                          
                              ######..####################################++                        
                            ########++######################################                        
                            ################################################..                      
                          --##########--  MM################mm  ##############                      
                          ##########        ::############..      MM##########                      
                          ########MM          ##########@@          ##########                      
                          ########              ########            MM########                      
                          ########      mm      ########      ####    ########                      
                          ######@@      ##MM    ########      ####    ########                      
                          ######::    mm####    ########    ######++  ########--                    
                          ##@@##..  ########    ######mm    ######mm  ########@@                    
                        mm######..  ########    ######MM    ######++  ######mm##                    
                        ##MM####MM  ########    ########    ######::  ######  ##                    
                      mm##--######  ######@@    ########    ######    ######..##MM                  
                    MM##  ########  MM####    ..########    ######  @@########  ##..                
                @@####  MM########--  ####    ##########++    ..    ##########::  ##++              
          ########    ++############        ::############        @@############MM  ####            
    MM####@@..      ##################..  ++################::::####################    MM####      
  ####::      --########################################################################    ..####  
::##      ::########mm--mm################################################@@        @@######    ::##
####      ################@@..    mm@@######################MM    @@##::++##################--    ##
  ##..  ++####::          MM####@@            --::----    ##      ######::            ..######    ##
    ##++  ####                ++########                --########MM                      ##..  ##::
      MM######  ##########        MM############----mm########++          --++@@MM--      ######    
            ##  @@##  ::####++        --##################--        mm########----######  ####      
          ##..    ##      ..####              --@@MM..          MM########--        ####    ##MM    
      ..##        ..##        ####                            ############          ##        ##MM  
      ##            ##--        ##::                        ######@@::##          ####          ##::
    ++##            ####        MM##                      ######..    ##          ####          ####
    ::##          --####          ##::                  ######::      ##          ####          ####
      ####..    mm######          @@##                ++######        ##          ####MM      ######
      --##############            ..##                ######--        ##          ################--
          ##########mm              ##              MM######          ##          ##  ##########    
                    ##::            ##              ####::##--        ##          ##                
                    ##@@            ##            ::####  ##MM        ##          ##                
                                    ##            ####    ##mm        ##--        ++                
                                  --##            ##::    mm          ##MM                          
                                  MM##          ..##                  ####                          
                                  ######        ####                  ####                          
                                  ######        ##MM                ++####                          
                                  ######        ##mm                mm####                          
                                  ####++      --##mm                  ####                          
                                    mm        ####MM                  ::                            
                                              ######                                                
                                              ######                                                
                                              ######                                                
                                              ######                                                
                                              ####mm                                                
            )" << "\n";
        }
        else if (inimigo->getNome() == "Goblin"){
            std::cout << R"(
                                                                                                                
                                                              MM                                    
                                                          --@@    ##                                
                                                @@    --##--      ##                                
                                              MM    ####..  ##MM  ####                              
                                            @@##MM####++    ####  ####                              
                                          ############    ######  ####                              
                                        ############MM  ########MM####                              
                                  --  ##############++  ##############                              
                                mmmm################mm################  ::                          
                              --##MM##################################..mm                          
                              ##########################################++                          
                            ::##########################################..                          
                            --############################################                          
                            ##############################################                          
  ::MM####@@--              ####  @@################################..####              --MM####MM::
        ::..--####@@        ####    ################################  ####        MM####++  MM      
            ####  ######    ####      ############################    ####..  MM####..::##--        
              ####MM  ####mm####--    ..########################::      ##::####....####MM          
              ####::##    ####--++      ::####################--  ..++  ####@@  ##++####            
                ##  ::@@    ######    ..  --################    mm  mm####    ##  ::####            
                ##mm  ####  ####  ++..--  mm  ##########..MM  MM  ..  ####  ####    ##              
                  @@  ######mm########mmmm..##++@@mm##::##  ##  ######  ##::####..##                
                      --####--  ########@@mm@@..######::MM##  ######--  mm######                    
                      ++######        ####MMMM##--      ##..####        ::####  --                  
              --  --####..::##  --####@@mm####::########..####::@@##mm  ::mm  mmMM  @@              
            ::--########..  ++    ####  ######@@  MMMM  ######mmMM####        ######  ##            
        mm  ##--##########  ..    @@##  --::######mm######mm::++++##    ..  ::########@@##          
      --  ################mm##  ..  ################++############@@MM  ##############  ##  ##      
      ##  ##  ##################    --##--##  ++++##mm::--..++  MM    ####::##########..######::    
    MM##--########################++      ##..##mm####++  ##        ######  ####################    
    ####--##############::######mm    ####--@@--########  ######  ##--####--####################    
    ####::##############..########    MM##::  @@--mm--##++  ##mm--  ::####mm####################    
    ####################--########..mm  ##++@@##  ####MM##++####--  MM####################::####    
    ####################MM########@@    MMMM      ..  ..MM++####..##++##########################    
    ##################################    ..@@  ::mm..######  ##--##MM##########################    
    @@##########################::####..##::  ..######@@        ################################    
    ..########################::  ######  ##  --##@@@@##  ..::@@##  ############################    
  ::..####################################  ##############++##################################::##  
  ################################--########    ######    ..####mm############################mm##  
  ################++  ######################::  ########  ####::##############..  ################  
  ################      ##############mm######@@############  ##############      --##############::
  ##############        ################@@++@@####--######::################        @@############++
  ############          ######################--@@  mm####################            @@##########++
  ##########            ::  ############################################MM..            mm########++
  ######MM                  ++########################################@@                    ######MM
::++++                        ########################################mm                      mmmmmm
                            mm  MM######MM##########################--mm                            
                                  @@##############################                                  
                                  ::@@############################                                  
                                    ############################                                    
                                      ########################..                                    
            )" << "\n";
        }
        else if (inimigo->getNome() == "Bruxa"){
            std::cout << R"(
                                                                                                                
                                                                            MM##..                  
                                                                        --####                      
                                                                      ::####..                      
                                                                      ####@@                        
                                                                    ######..                        
                                                                  ..######                          
                                                --                ++######                          
                                                  ##              ########                          
                                                  ####            ########                          
                                                  ####++          ########                          
                                                  ######          ########                          
                                              ##############      @@######++                        
                    ..##....++                  mm######@@        --########                        
                    ############mm..++mm::    ++########@@          ##########                      
                    ######################mm@@########@@..          ::##########                    
                  ..##############################@@  ##              @@##########--        ..      
                  ############--  ##  ..##########MM                    @@##################--      
            mm##@@########  mm        ##############                      --##############          
            @@########MM--          ################                          ..------              
            ##########          ++####################++                                            
            ##########        ################  mm##########::..::  --@@mm                          
            ##########..      ##################@@mm################                                
      ::########@@            ####################MM@@########@@  MM                                
        ########              ##############################                                        
      ++  ####..                ####################::MM####                                        
      ..####++                  ..##################--  ##..                                        
        ##########::      --MM########################                                              
        ..##################MM      ##############++mm                                              
          ##############mm            ######..  ##                                                  
            ##########..                ####  --##                                                  
            ######--                      ##----..##mm                                              
                                          ##++                                                      
                                          MM++                                                      
                                            @@                                                      
            )" << "\n";
        };
        
        while (jogador.estaVivo() && inimigo->estaVivo()) {
            std::cout << "\n";
            battlePrint("Vida: " + std::to_string(jogador.getVida()) + "/" + std::to_string(jogador.getVidaMax()) + " | Pocoes: " + std::to_string(jogador.getPocoes()) + "\n");
            battlePrint("Inimigo: " + inimigo->getNome() + " | Vida: " + std::to_string(inimigo->getVida()) + "/" + std::to_string(inimigo->getVidaMax()) + "\n");

            jogador.processarEfeitos();
            if (!jogador.estaVivo()) break;

            if (jogador.getEfeito().tipo != TipoEfeito::Paralisia) { // LÃ³gica de paralisia refinada
                typeText("Escolha uma acao:\n1 - Atacar\n2 - Defender\n3 - Usar Pocao\nOpcao: ", TextSpeed::NORMAL);
                int acao;
                std::cin >> acao;

                switch (acao) {
                    case 1:
                        jogador.atacar(*inimigo);
                        inimigo->aoReceberDano(jogador.getAtaque());
                        break;
                    case 2:
                        jogador.defender();
                        break;
                    case 3:
                        jogador.usarPocao();
                        break;
                    default:
                        battlePrint("Acao invalida. Voce perdeu o turno!\n");
                        std::cin.clear(); // Tratamento de erro
                        std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n'); // Tratamento de erro
                        break;
                }
            }

            if (inimigo->estaVivo()) {
                inimigo->aoAtacar(jogador);
                inimigo->atacar(jogador);
            }
        }

        if (!inimigo->estaVivo()) {
            battlePrint(inimigo->getNome() + " foi derrotado!\n");
        }
    }
    inimigos.clear();
}